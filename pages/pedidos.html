<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos en curso - Pastelería 1000 Sabores</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="icon" type="image/png" href="../assets/img/logo.png">
</head>
<body>
    <script>
        // Solo vendedores (y admins si quieres probar)
        (function guard(){
            const u = JSON.parse(localStorage.getItem('sessionUser')||'null');
            if (!u) { window.location.href = '../login.html'; return; }
            if (!['vendedor','admin'].includes(u.rol)) { window.location.href = '../index.html'; }
        })();
    </script>
    <header>
        <nav class="navbar navbar-light" style="background-color: #FFF5E1;">
            <div class="container">
                <a class="navbar-brand" href="../index.html">
                    <img src="../assets/img/logo.png" alt="Logo Pastelería 1000 Sabores" width="32" height="32" class="d-inline-block align-text-top logo-svg">
                    Pastelería 1000 Sabores
                </a>
                <div class="ms-auto d-flex gap-2">
                    <a class="btn btn-outline-primary" href="../index.html">Volver</a>
                    <a class="btn btn-primary" href="../login.html" onclick="localStorage.removeItem('sessionUser');localStorage.removeItem('usuarioActual');">Cerrar sesión</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mt-4">
        <h1 class="text-center mb-4">Pedidos en curso</h1>
        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" style="color:#8B4513;">Listado de pedidos</h5>
                        <div id="listaPedidos"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title" style="color:#8B4513;">Stock actual</h5>
                        <div id="listaStock"></div>
                        <small class="text-muted">Solo lectura para vendedor.</small>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center mt-5">
        <p>&copy; 2025 Pastelería 1000 Sabores. Todos los derechos reservados.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
    <script>
        // ===== GESTIÓN DE PEDIDOS REALES =====
        // Muestra órdenes reales creadas por los clientes y permite marcarlas como completadas

        // Obtener productos del catálogo
        function getProductos() {
            try {
                return JSON.parse(localStorage.getItem('productos') || '[]');
            } catch(e) {
                return [];
            }
        }

        // Obtener órdenes reales desde localStorage
        function getOrdenes() {
            try {
                return JSON.parse(localStorage.getItem('ordenes') || '[]');
            } catch(e) {
                return [];
            }
        }

        // Guardar órdenes actualizadas
        function saveOrdenes(ordenes) {
            localStorage.setItem('ordenes', JSON.stringify(ordenes));
        }

        // Actualizar estado de una orden
        function actualizarEstadoOrden(numeroPedido, nuevoEstado) {
            const ordenes = getOrdenes();
            const ordenIndex = ordenes.findIndex(o => o.numeroPedido === numeroPedido);
            
            if (ordenIndex >= 0) {
                ordenes[ordenIndex].estado = nuevoEstado;
                
                // Si se marca como completada, actualizar fecha de entrega
                if (nuevoEstado === 'Entregado') {
                    ordenes[ordenIndex].seguimiento.entregado = new Date().toISOString();
                }
                
                saveOrdenes(ordenes);
                return true;
            }
            return false;
        }

        // Renderizar pedidos reales
        function renderPedidos() {
            const cont = document.getElementById('listaPedidos');
            const ordenes = getOrdenes();
            
            // Filtrar solo órdenes que no estén completadas
            const pedidosPendientes = ordenes.filter(orden => orden.estado !== 'Entregado');
            
            if (pedidosPendientes.length === 0) {
                cont.innerHTML = '<div class="alert alert-info">No hay pedidos en curso.</div>';
                return;
            }

            const frag = document.createDocumentFragment();
            
            pedidosPendientes.forEach(orden => {
                const div = document.createElement('div');
                div.className = 'border rounded p-3 mb-3';
                
                // Formatear fecha
                const fecha = new Date(orden.fecha).toLocaleDateString('es-CL');
                const hora = new Date(orden.fecha).toLocaleTimeString('es-CL');
                
                // Determinar color del estado
                let estadoColor = '#8B4513';
                let estadoTexto = orden.estado;
                
                switch(orden.estado) {
                    case 'En preparación':
                        estadoColor = '#FFC0CB';
                        break;
                    case 'En horneado':
                        estadoColor = '#B0BEC5';
                        break;
                    case 'Empaquetado':
                        estadoColor = '#B0BEC5';
                        break;
                    case 'En despacho':
                        estadoColor = '#B0BEC5';
                        break;
                }
                
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>Pedido ${orden.numeroPedido}</strong>
                            <span class="badge ms-2" style="background-color: ${estadoColor}; color: #5D4037;">${estadoTexto}</span><br>
                            <span style="color:#5D4037;">${orden.usuario.nombre} — ${orden.usuario.correo}</span><br>
                            <small class="text-muted">Fecha: ${fecha} ${hora}</small><br>
                            <small class="text-muted">Dirección: ${orden.usuario.direccion}, ${orden.usuario.comuna}</small>
                        </div>
                        <div class="text-end">
                            <div style="color:#8B4513; font-weight:bold;">$${orden.total.toLocaleString('es-CL')}</div>
                            ${orden.descuentoInfo ? `<small class="text-success">Descuento: ${orden.descuentoInfo.tipo}</small><br>` : ''}
                            <button class="btn btn-sm btn-success mt-2" data-completar="${orden.numeroPedido}">
                                Marcar como Entregado
                            </button>
                        </div>
                    </div>
                    <div class="mt-2" style="color:#5D4037;">
                        <strong>Productos:</strong><br>
                        ${orden.productos.map(p => `${p.nombre} x${p.cantidad} - $${(p.precio * p.cantidad).toLocaleString('es-CL')}`).join('<br>')}
                    </div>
                `;
                frag.appendChild(div);
            });
            
            cont.innerHTML = '';
            cont.appendChild(frag);
        }

        // Renderizar stock de productos
        function renderStock() {
            const cont = document.getElementById('listaStock');
            const productos = getProductos();
            
            if (productos.length === 0) {
                cont.innerHTML = '<div class="alert alert-info">No hay productos disponibles.</div>';
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'list-group';
            
            productos.forEach(producto => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <span style="color:#5D4037;">${producto.id} - ${producto.nombre}</span>
                    <span class="badge" style="background-color:#8B4513;">${producto.stock || '-'}</span>
                `;
                ul.appendChild(li);
            });
            
            cont.innerHTML = '';
            cont.appendChild(ul);
        }

        // Event listener para botones de completar pedido
        document.addEventListener('click', function(e) {
            if (e.target && e.target.hasAttribute('data-completar')) {
                const numeroPedido = e.target.getAttribute('data-completar');
                
                if (confirm(`¿Está seguro de marcar el pedido ${numeroPedido} como entregado?`)) {
                    const actualizado = actualizarEstadoOrden(numeroPedido, 'Entregado');
                    
                    if (actualizado) {
                        alert('✅ Pedido marcado como entregado exitosamente.');
                        renderPedidos(); // Refrescar la lista
                    } else {
                        alert('❌ Error al actualizar el pedido.');
                    }
                }
            }
        });

        // Inicializar página
        renderPedidos();
        renderStock();
    </script>
</body>
</html>


